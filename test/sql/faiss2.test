# name: test/sql/quack.test
# description: test quack extension
# group: [quack]

require faiss

statement ok
CALL faiss_create('flat82', 8, 'IDMap,Flat');

statement ok
create table vectors as SELECT column0 lbl, list_value(column1, column2, column3, column4, column5, column6, column7, column8) emb FROM 'test/sql/training.csv'


statement ok
CALL faiss_add('flat82', (SELECT lbl, emb FROM vectors))

query II
WITH
queries AS (SELECT * FROM 'test/sql/queries.csv'),
labels AS (SELECT UNNEST(faiss_search('flat82', 2, list_value(column1, column2, column3, column4, column5, column6, column7, column8))).label lbl FROM queries)
SELECT * FROM labels JOIN vectors USING(lbl)
----
10	[0.07759538, 0.79359758, 0.59450358, 0.7327987, 0.69523287, 0.67981976, 0.39232048, 0.56155747]
13	[0.13254718, 0.47195679, 0.34021971, 0.52984196, 0.71610069, 0.98837942, 0.72049344, 0.91257751]
17	[0.09455702, 0.62738436, 0.00809391, 0.68028706, 0.5339331, 0.43866682, 0.19955121, 0.13800132]
35	[0.45897833, 0.68980128, 0.25394312, 0.40151957, 0.26447654, 0.93425059, 0.47252524, 0.6109162]
102	[0.20037061, 0.69749159, 0.21595132, 0.77783, 0.08073661, 0.40530115, 0.20749044, 0.08503267]
152	[0.87312001, 0.02016815, 0.37465107, 0.31326103, 0.49830529, 0.72918338, 0.71494114, 0.12601531]
175	[0.23581797, 0.71012294, 0.62502801, 0.87714744, 0.34411114, 0.71768564, 0.44465351, 0.18107539]
183	[0.29086816, 0.87553072, 0.44954228, 0.26103067, 0.75938821, 0.80490518, 0.24139677, 0.34777254]
218	[0.37839508, 0.7406227, 0.15547635, 0.16013685, 0.3911472, 0.58697164, 0.63756871, 0.06352914]
228	[0.50663543, 0.76936567, 0.69882298, 0.98654795, 0.39877021, 0.84380466, 0.49374056, 0.78707737]
235	[0.57938331, 0.3994368, 0.36766377, 0.03523716, 0.58124298, 0.45113447, 0.75197047, 0.06738858]
279	[0.87924141, 0.5777024, 0.7013517, 0.89796156, 0.04920615, 0.82628155, 0.59932601, 0.46577334]
301	[0.71198934, 0.35442016, 0.44742194, 0.79522467, 0.25797454, 0.77324748, 0.80228746, 0.94508737]
361	[0.36313871, 0.92564791, 0.45735809, 0.77347225, 0.72599894, 0.91991353, 0.46936458, 0.59764755]
366	[0.63148618, 0.68233663, 0.20436898, 0.87805635, 0.86877018, 0.06280956, 0.01237864, 0.71652949]
371	[0.59105188, 0.81271636, 0.82015961, 0.79144913, 0.18274984, 0.85260475, 0.66285431, 0.07306755]
385	[0.40584409, 0.11856958, 0.12180881, 0.73967415, 0.98149097, 0.99203575, 0.77157772, 0.61335856]
578	[0.97446245, 0.42847365, 0.36192453, 0.96569479, 0.18860541, 0.78881878, 0.88497031, 0.70970565]
745	[0.8782438, 0.54563749, 0.33149472, 0.71029246, 0.5443989, 0.4230305, 0.16425151, 0.46068236]
115	[0.17042167, 0.97991478, 0.79251659, 0.63918024, 0.32432637, 0.97267902, 0.50523496, 0.9214434]

statement ok
CALL faiss_destroy('flat82');